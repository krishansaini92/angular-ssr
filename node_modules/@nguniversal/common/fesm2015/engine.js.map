{"version":3,"file":"engine.js","sources":["../../../../../../modules/common/engine/src/utils.ts","../../../../../../modules/common/engine/src/file-loader.ts","../../../../../../modules/common/engine/src/inline-css-processor.ts","../../../../../../modules/common/engine/src/engine.ts","../../../../../../modules/common/engine/private_api.ts","../../../../../../modules/common/engine/public_api.ts","../../../../../../modules/common/engine/index.ts","../../../../../../modules/common/engine/engine.ts"],"sourcesContent":["/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport * as fs from 'fs';\nimport { promisify } from 'util';\n\nexport const readFile = promisify(fs.readFile);\nexport const access = promisify(fs.access);\n\nexport async function exists(path: fs.PathLike): Promise<boolean> {\n  try {\n    await access(path, fs.constants.F_OK);\n\n    return true;\n  } catch {\n    return false;\n  }\n}\n","/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\nimport { ResourceLoader } from '@angular/compiler';\nimport { readFile } from './utils';\n\n/** ResourceLoader implementation for loading files */\nexport class FileLoader implements ResourceLoader {\n  get(url: string): Promise<string> {\n    return readFile(url, 'utf-8');\n  }\n}\n","/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport Critters from 'critters';\nimport { readFile } from './utils';\n\nexport interface InlineCriticalCssProcessOptions {\n  outputPath?: string;\n}\n\nexport interface InlineCriticalCssProcessorOptions {\n  minify?: boolean;\n  deployUrl?: string;\n}\n\nclass CrittersExtended extends Critters {\n  readonly warnings: string[] = [];\n  readonly errors: string[] = [];\n\n  constructor(\n    private readonly optionsExtended: InlineCriticalCssProcessorOptions & InlineCriticalCssProcessOptions,\n    private readonly resourceCache: Map<string, string>,\n  ) {\n    super({\n      logger: {\n        warn: (s: string) => this.warnings.push(s),\n        error: (s: string) => this.errors.push(s),\n        log: () => { },\n        info: () => { },\n      },\n      path: optionsExtended.outputPath,\n      publicPath: optionsExtended.deployUrl,\n      compress: !!optionsExtended.minify,\n      pruneSource: false,\n      reduceInlineStyles: false,\n      mergeStylesheets: false,\n      preload: 'media',\n      noscriptFallback: true,\n      // Cast any is needed because of logger API is not exposed as part of the options\n      // https://github.com/GoogleChromeLabs/critters/issues/66\n      // tslint:disable-next-line: no-any\n    } as any);\n  }\n\n  protected async readFile(path: string): Promise<string> {\n    let resourceContent = this.resourceCache.get(path);\n    if (resourceContent === undefined) {\n      resourceContent = await readFile(path, 'utf-8');\n      this.resourceCache.set(path, resourceContent);\n    }\n\n    return resourceContent;\n  }\n}\n\nexport class InlineCriticalCssProcessor {\n  private readonly resourceCache = new Map<string, string>();\n\n  constructor(protected readonly options: InlineCriticalCssProcessorOptions) { }\n\n  async process(html: string, options: InlineCriticalCssProcessOptions)\n    : Promise<{ content: string, warnings: string[], errors: string[] }> {\n\n    const critters = new CrittersExtended({ ...this.options, ...options }, this.resourceCache);\n    const content = await critters.process(html);\n\n    return {\n      content,\n      errors: critters.errors,\n      warnings: critters.warnings,\n    };\n  }\n}\n","/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\nimport { ResourceLoader } from '@angular/compiler';\nimport { Compiler, CompilerFactory, NgModuleFactory, StaticProvider, Type } from '@angular/core';\nimport { INITIAL_CONFIG, platformDynamicServer, renderModuleFactory } from '@angular/platform-server';\nimport { dirname, resolve } from 'path';\n\nimport { FileLoader } from './file-loader';\nimport { InlineCriticalCssProcessor } from './inline-css-processor';\nimport { exists, readFile } from './utils';\n\n/** These are the allowed options for the render */\nexport interface RenderOptions {\n  bootstrap: Type<{}> | NgModuleFactory<{}>;\n  providers?: StaticProvider[];\n  url?: string;\n  document?: string;\n  documentFilePath?: string;\n  /**\n   * Reduce render blocking requests by inlining critical CSS.\n   * Defaults to false.\n   */\n  inlineCriticalCss?: boolean;\n  /**\n   * Base path location of index file.\n   * Defaults to the 'documentFilePath' dirname when not provided.\n   */\n  publicPath?: string;\n}\n\n/**\n * A common rendering engine utility. This abstracts the logic\n * for handling the platformServer compiler, the module cache, and\n * the document loader\n */\nexport class CommonEngine {\n\n  private readonly factoryCacheMap = new Map<Type<{}>, NgModuleFactory<{}>>();\n  private readonly templateCache = new Map<string, string>();\n  private readonly inlineCriticalCssProcessor: InlineCriticalCssProcessor;\n  private readonly pageExists = new Map<string, boolean>();\n\n  constructor(private moduleOrFactory?: Type<{}> | NgModuleFactory<{}>,\n              private providers: StaticProvider[] = []) {\n    this.inlineCriticalCssProcessor = new InlineCriticalCssProcessor({\n      minify: true,\n    });\n  }\n\n  /**\n   * Render an HTML document for a specific URL with specified\n   * render options\n   */\n  async render(opts: RenderOptions): Promise<string> {\n    if (opts.publicPath && opts.documentFilePath && opts.url !== undefined) {\n      const url = new URL(opts.url);\n      // Remove leading forward slash.\n      const pathname  = url.pathname.substring(1);\n      const pagePath = resolve(opts.publicPath, pathname, 'index.html');\n\n      if (pagePath !== resolve(opts.documentFilePath)) {\n        // View path doesn't match with prerender path.\n        let pageExists = this.pageExists.get(pagePath);\n        if (pageExists === undefined) {\n          pageExists = await exists(pagePath);\n          this.pageExists.set(pagePath, pageExists);\n        }\n\n        if (pageExists) {\n          // Serve pre-rendered page.\n          return readFile(pagePath, 'utf-8');\n        }\n      }\n    }\n\n    // if opts.document dosen't exist then opts.documentFilePath must\n    const extraProviders = [\n      ...(opts.providers || []),\n      ...(this.providers || []),\n    ];\n\n    let doc = opts.document;\n    if (!doc && opts.documentFilePath) {\n      doc = await this.getDocument(opts.documentFilePath);\n    }\n\n    if (doc) {\n      extraProviders.push({\n        provide: INITIAL_CONFIG,\n        useValue: {\n          document: opts.inlineCriticalCss\n            // Workaround for https://github.com/GoogleChromeLabs/critters/issues/64\n            ? doc.replace(/ media=\\\"print\\\" onload=\\\"this\\.media='all'\"><noscript><link .+?><\\/noscript>/g, '>')\n            : doc,\n          url: opts.url\n        }\n      });\n    }\n\n    const moduleOrFactory = this.moduleOrFactory || opts.bootstrap;\n    const factory = await this.getFactory(moduleOrFactory);\n\n    const html = await renderModuleFactory(factory, { extraProviders });\n    if (!opts.inlineCriticalCss) {\n      return html;\n    }\n\n    const { content, errors, warnings } = await this.inlineCriticalCssProcessor.process(html, {\n      outputPath: opts.publicPath ?? (opts.documentFilePath ? dirname(opts.documentFilePath) : undefined),\n    });\n\n    // tslint:disable-next-line: no-console\n    warnings.forEach(m => console.warn(m));\n    // tslint:disable-next-line: no-console\n    errors.forEach(m => console.error(m));\n\n    return content;\n  }\n\n  /** Return the factory for a given engine instance */\n  private async getFactory(moduleOrFactory: Type<{}> | NgModuleFactory<{}>): Promise<NgModuleFactory<{}>> {\n    // If module has been compiled AoT\n    if (moduleOrFactory instanceof NgModuleFactory) {\n      return moduleOrFactory;\n    } else {\n      // we're in JIT mode\n      const moduleFactory = this.factoryCacheMap.get(moduleOrFactory);\n\n      // If module factory is cached\n      if (moduleFactory) {\n        return moduleFactory;\n      }\n\n      // Compile the module and cache it\n      const factory = await this.getCompiler().compileModuleAsync(moduleOrFactory);\n      this.factoryCacheMap.set(moduleOrFactory, factory);\n\n      return factory;\n    }\n  }\n\n  /** Retrieve the document from the cache or the filesystem */\n  private async getDocument(filePath: string): Promise<string> {\n    let doc = this.templateCache.get(filePath);\n\n    if (!doc) {\n      doc = await readFile(filePath, 'utf-8');\n      this.templateCache.set(filePath, doc);\n    }\n\n    return doc;\n  }\n\n  /** Return an instance of the platformServer compiler */\n  private getCompiler(): Compiler {\n    const compilerFactory: CompilerFactory = platformDynamicServer().injector.get(CompilerFactory);\n\n    return compilerFactory.createCompiler([\n      { providers: [{ provide: ResourceLoader, useClass: FileLoader, deps: [] }] }\n    ]);\n  }\n}\n","/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nexport {\n  CommonEngine as ɵCommonEngine,\n  RenderOptions as ɵRenderOptions,\n} from './src/engine';\n\nexport {\n  InlineCriticalCssProcessor as ɵInlineCriticalCssProcessor,\n} from './src/inline-css-processor';\n","/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\nexport * from './private_api';\n","/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\nexport * from './public_api';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":["fs.readFile","fs.access","fs.constants"],"mappings":"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"}